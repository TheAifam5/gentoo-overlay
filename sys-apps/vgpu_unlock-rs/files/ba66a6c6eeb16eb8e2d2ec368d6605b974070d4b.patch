From ba66a6c6eeb16eb8e2d2ec368d6605b974070d4b Mon Sep 17 00:00:00 2001
From: Matt Bilker <me@mbilker.us>
Date: Wed, 25 Sep 2024 04:35:50 +0000
Subject: [PATCH 1/7] lib: do not take mdev UUID as 17.x may get the vGPU info
 multiple times

- See #37
---
 src/lib.rs | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/lib.rs b/src/lib.rs
index eddb72d..6e1ffad 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -539,7 +539,7 @@ fn handle_profile_override<C: VgpuConfigLike>(config: &mut C) -> bool {
     };
 
     let vgpu_type = format!("nvidia-{}", config.vgpu_type());
-    let mdev_uuid = LAST_MDEV_UUID.lock().take();
+    let mdev_uuid = LAST_MDEV_UUID.lock().clone();
 
     if let Some(config_override) = config_overrides.profile.get(vgpu_type.as_str()) {
         info!("Applying profile {} overrides", vgpu_type);

From ff3e6e4b81cb3ede42a320f383667a3614aa7f04 Mon Sep 17 00:00:00 2001
From: bennaber <39690241+bennaber@users.noreply.github.com>
Date: Tue, 1 Apr 2025 11:53:54 +0200
Subject: [PATCH 2/7] lib: added params_size of 5232 bytes for v18 driver
 compatibility (#43)

Co-authored-by: plaguenarr <plaguenarr@MacBook-Pro-von-plaguenarr.local>
---
 src/lib.rs | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/src/lib.rs b/src/lib.rs
index 6e1ffad..f1254c2 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -444,9 +444,10 @@ pub unsafe extern "C" fn ioctl(fd: RawFd, request: c_ulong, argp: *mut c_void) -
                 *LAST_MDEV_UUID.lock() = Some(params.vgpu_name);
             }
             NVA081_CTRL_CMD_VGPU_CONFIG_GET_VGPU_TYPE_INFO => {
-                // 17.0 driver sends larger struct with size 5096 bytes. Only extra members added at the end,
+                // 18.0 driver sends larger struct with size 5232 bytes, 17.0 driver sends larger struct with size 5096 bytes. Only extra members added at the end,
                 // nothing in between or changed, so accessing the larger struct is "safe"
-                if io_data.params_size == 5096
+                if io_data.params_size == 5232
+                    || io_data.params_size == 5096
                     || check_size!(
                         NVA081_CTRL_CMD_VGPU_CONFIG_GET_VGPU_TYPE_INFO,
                         NvA081CtrlVgpuConfigGetVgpuTypeInfoParams

From df0090a5426a446eb26013623130ef5c15ec483a Mon Sep 17 00:00:00 2001
From: Coia Prant <coiaprant@gmail.com>
Date: Mon, 2 Jun 2025 23:59:49 +0800
Subject: [PATCH 3/7] nvidia(ctrla081): replace R550 link reference

Latest fields in line 126-128

Signed-off-by: Coia Prant <coiaprant@gmail.com>
---
 src/nvidia/ctrla081.rs | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/nvidia/ctrla081.rs b/src/nvidia/ctrla081.rs
index 32618f9..a02dafd 100644
--- a/src/nvidia/ctrla081.rs
+++ b/src/nvidia/ctrla081.rs
@@ -54,7 +54,7 @@ pub struct NvA081CtrlVgpuInfo {
     pub exclusive_size: u32,
     pub gpu_instance_profile_id: u32,
     // R550 adds additional fields, leave them out for now for backwards compat with 16.x
-    // https://github.com/NVIDIA/open-gpu-kernel-modules/blob/550/src/common/sdk/nvidia/inc/ctrl/ctrla081.h#L122-L124
+    // https://github.com/NVIDIA/open-gpu-kernel-modules/blob/550/src/common/sdk/nvidia/inc/ctrl/ctrla081.h#L126-L128
     // pub placement_size: u32,
     // pub placement_count: u32,
     // pub placement_ids: [u32; NVA081_MAX_VGPU_PER_PGPU],

From e83bb8135b42492035efd6a4522671bc807e9aed Mon Sep 17 00:00:00 2001
From: Coia Prant <coiaprant@gmail.com>
Date: Tue, 3 Jun 2025 00:08:40 +0800
Subject: [PATCH 4/7] nvidia(ctrla081): sync vGPU 18.x (R570) fields

Synchronizing fields for vGPU 18.x (R570)

Signed-off-by: Coia Prant <coiaprant@gmail.com>
---
 src/nvidia/ctrla081.rs | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/nvidia/ctrla081.rs b/src/nvidia/ctrla081.rs
index a02dafd..2548cbf 100644
--- a/src/nvidia/ctrla081.rs
+++ b/src/nvidia/ctrla081.rs
@@ -55,9 +55,18 @@ pub struct NvA081CtrlVgpuInfo {
     pub gpu_instance_profile_id: u32,
     // R550 adds additional fields, leave them out for now for backwards compat with 16.x
     // https://github.com/NVIDIA/open-gpu-kernel-modules/blob/550/src/common/sdk/nvidia/inc/ctrl/ctrla081.h#L126-L128
+    // R570 rename these fields
+    // https://github.com/NVIDIA/open-gpu-kernel-modules/blob/570/src/common/sdk/nvidia/inc/ctrl/ctrla081.h#L126-L128
+    //
     // pub placement_size: u32,
-    // pub placement_count: u32,
-    // pub placement_ids: [u32; NVA081_MAX_VGPU_PER_PGPU],
+    // pub homogeneousPlacementCount: u32, // pub placement_count: u32,
+    // pub homogeneousPlacementIds: [u32; NVA081_MAX_VGPU_PER_PGPU], // pub placement_ids: [u32; NVA081_MAX_VGPU_PER_PGPU],
+    //
+    // R570 adds additional fields, leave them out for now for backwards compat with 16.x and 17.x
+    // https://github.com/NVIDIA/open-gpu-kernel-modules/blob/570/src/common/sdk/nvidia/inc/ctrl/ctrla081.h#L129-L130
+    //
+    // pub heterogeneousPlacementCount: u32,
+    // pub heterogeneousPlacementIds: [u32; NVA081_MAX_VGPU_PER_PGPU],
 }
 
 pub const NVA081_CTRL_CMD_VGPU_CONFIG_GET_VGPU_TYPE_INFO: u32 = 0xa0810103;

From bb613be50acbf1479ba32bd79a55705645754b3d Mon Sep 17 00:00:00 2001
From: Coia Prant <coiaprant@gmail.com>
Date: Tue, 3 Jun 2025 00:12:13 +0800
Subject: [PATCH 5/7] nvidia(ctrl0000vgpu): sync vGPU 18.x (R570) fields

Synchronizing fields for vGPU 18.x (R570)

Signed-off-by: Coia Prant <coiaprant@gmail.com>
---
 src/nvidia/ctrl0000vgpu.rs | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/nvidia/ctrl0000vgpu.rs b/src/nvidia/ctrl0000vgpu.rs
index 6e477b4..3eb820c 100644
--- a/src/nvidia/ctrl0000vgpu.rs
+++ b/src/nvidia/ctrl0000vgpu.rs
@@ -40,6 +40,11 @@ pub struct Nv0000CtrlVgpuCreateDeviceParams {
     pub gpu_pci_bdf: u32,
     pub vgpu_type_id: u32,
     pub vgpu_id: u16,
+    // R570 adds additional fields, leave them out for now for backwards compat with 16.x and 17.x
+    // https://github.com/NVIDIA/open-gpu-kernel-modules/blob/570/src/common/sdk/nvidia/inc/ctrl/ctrl0000/ctrl0000vgpu.h#L94-L95
+    //
+    // pub gpuInstanceId: u32,
+    // pub placementId: u32,
 }
 
 impl fmt::Debug for Nv0000CtrlVgpuCreateDeviceParams {

From 0ff7938678dd9a0ea3bb0ad44567ed85d830cf50 Mon Sep 17 00:00:00 2001
From: Coia Prant <coiaprant@gmail.com>
Date: Tue, 3 Jun 2025 00:15:35 +0800
Subject: [PATCH 6/7] nvidia(ctrl0080gpu): sync vGPU 18.x (R570) fields

Synchronizing fields for vGPU 18.x (R570)

Signed-off-by: Coia Prant <coiaprant@gmail.com>
---
 src/nvidia/ctrl0080gpu.rs | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/src/nvidia/ctrl0080gpu.rs b/src/nvidia/ctrl0080gpu.rs
index af67d13..b64a834 100644
--- a/src/nvidia/ctrl0080gpu.rs
+++ b/src/nvidia/ctrl0080gpu.rs
@@ -9,4 +9,8 @@ pub const NV0080_CTRL_GPU_VIRTUALIZATION_MODE_HOST: u32 = 0x00000003;
 #[repr(C)]
 pub struct Nv0080CtrlGpuGetVirtualizationModeParams {
     pub virtualization_mode: u32,
+    // R570 adds additional fields, leave them out for now for backwards compat with 16.x and 17.x
+    // https://github.com/NVIDIA/open-gpu-kernel-modules/blob/570/src/common/sdk/nvidia/inc/ctrl/ctrl0080/ctrl0080gpu.h#L313
+    //
+    // pub isGridBuild: bool,
 }

From a31da7a87d6c64c9270dec3a2dea51b9f4538b83 Mon Sep 17 00:00:00 2001
From: Coia Prant <coiaprant@gmail.com>
Date: Tue, 3 Jun 2025 00:21:55 +0800
Subject: [PATCH 7/7] lib: added params_size for v18 driver compatibility

In vGPU 18.x (R570)
- Parameters size for `NV0000_CTRL_CMD_VGPU_CREATE_DEVICE` was 40 bytes
- Parameters size for `NV0080_CTRL_CMD_GPU_GET_VIRTUALIZATION_MODE` was 8 bytes

Signed-off-by: Coia Prant <coiaprant@gmail.com>
---
 src/lib.rs | 16 +++++++++++-----
 1 file changed, 11 insertions(+), 5 deletions(-)

diff --git a/src/lib.rs b/src/lib.rs
index f1254c2..ece6372 100644
--- a/src/lib.rs
+++ b/src/lib.rs
@@ -394,7 +394,10 @@ pub unsafe extern "C" fn ioctl(fd: RawFd, request: c_ulong, argp: *mut c_void) -
             params.pci_sub_system_id = (orig_sub_system_id & 0xffff) | (spoofed_subsysid << 16);
         }
         NV0080_CTRL_CMD_GPU_GET_VIRTUALIZATION_MODE
-            if check_size!(
+        // 18.0 driver sends larger struct with size 8 bytes. Only extra members added at the end,
+        // nothing in between or changed, so accessing the larger struct is "safe"
+        if io_data.params_size == 8
+            || check_size!(
                 NV0080_CTRL_CMD_GPU_GET_VIRTUALIZATION_MODE,
                 Nv0080CtrlGpuGetVirtualizationModeParams
             ) && CONFIG.unlock =>
@@ -432,10 +435,13 @@ pub unsafe extern "C" fn ioctl(fd: RawFd, request: c_ulong, argp: *mut c_void) -
                 *LAST_MDEV_UUID.lock() = Some(config.mdev_uuid);
             }
             NV0000_CTRL_CMD_VGPU_CREATE_DEVICE
-                if check_size!(
-                    NV0000_CTRL_CMD_VGPU_CREATE_DEVICE,
-                    Nv0000CtrlVgpuCreateDeviceParams
-                ) =>
+                // 18.0 driver sends larger struct with size 40 bytes. Only extra members added at the end,
+                // nothing in between or changed, so accessing the larger struct is "safe"
+                if io_data.params_size == 40
+                    || check_size!(
+                        NV0000_CTRL_CMD_VGPU_CREATE_DEVICE,
+                        Nv0000CtrlVgpuCreateDeviceParams
+                    ) =>
             {
                 // 17.0 driver provides mdev uuid as vgpu_name in this command
                 let params: &mut Nv0000CtrlVgpuCreateDeviceParams = &mut *io_data.params.cast();
